%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Generic template for TFC/TFM/TFG/Tesis
%
% $Id: estudioTeorico.tex,v 1.5 2015/06/05 00:05:19 macias Exp $
%
% By:
%  + Javier Macías-Guarasa.
%    Departamento de Electrónica
%    Universidad de Alcalá
%  + Roberto Barra-Chicote.
%    Departamento de Ingeniería Electrónica
%    Universidad Politécnica de Madrid
% 
% Based on original sources by Roberto Barra, Manuel Ocaña, Jesús Nuevo, Pedro Revenga, Fernando Herránz and Noelia Hernández. Thanks a lot to all of them, and to the many anonymous contributors found (thanks to google) that provided help in setting all this up.
%
% See also the additionalContributors.txt file to check the name of additional contributors to this work.
%
% If you think you can add pieces of relevant/useful examples, improvements, please contact us at (macias@depeca.uah.es)
%
% You can freely use this template and please contribute with comments or suggestions!!!
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Estudio teórico y estado del arte}
\label{cha:estudio-teorico}

Este capítulo presenta los conceptos fundamentales sobre emulación y virtualización en el contexto de los sistemas embebidos, 
así como un análisis del uso actual de herramientas como QEMU en investigación, industria y plataformas abiertas como RISC-V. 
Se introduce además la relevancia de Gaisler y su arquitectura NOEL-V, dado su vínculo directo con el sistema virtualizado desarrollado en este trabajo \cite{gaisler-noelv,grlib}.

\section{Introducción}

El diseño y validación de sistemas embebidos ha evolucionado significativamente gracias a las técnicas de emulación y virtualización. 
Estas herramientas permiten desarrollar y probar software en ausencia del hardware final, reduciendo costos, acelerando el ciclo de desarrollo 
y facilitando tareas como la depuración, la automatización del testing o la validación funcional temprana 
\cite{zabolotny2021qemu,cinque2021qemu}.

QEMU, una de las plataformas de emulación más utilizadas, ofrece un entorno flexible y extensible para modelar sistemas heterogéneos, 
incluyendo SoCs personalizados y arquitecturas no convencionales como RISC-V \cite{qemu,qemu_wikipedia,riscv_wikipedia}. 
Este capítulo profundiza en su rol actual en proyectos reales, tanto en academia como en la industria 
\cite{guo2019fast,vizcaino2024rave}.

\section{Emulación y virtualización en sistemas embebidos}

\subsection*{Conceptos fundamentales}

\begin{itemize}
    \item \textbf{Virtualización:} Técnica que permite ejecutar múltiples sistemas operativos sobre una misma plataforma 
    física mediante hipervisores, compartiendo recursos del hardware. Es común en entornos cloud y servidores \cite{virtualization_wikipedia}.
    
    \item \textbf{Emulación:} Técnica que replica el comportamiento completo de un sistema hardware en otro diferente, 
    tanto a nivel de CPU como de periféricos. Resulta clave para arquitecturas personalizadas, ISA alternativas o hardware aún no fabricado 
    \cite{embedded_sim_vs_emul,emul_vs_virtualization_eureka}.
\end{itemize}

En el ámbito embebido, la emulación resulta especialmente útil para validar periféricos, 
probar firmwares y desarrollar software sin necesidad de acceso físico al hardware \cite{zabolotny2021qemu}.


\section{QEMU como emulador abierto y extensible}

\subsection{Historia y evolución}

QEMU (Quick Emulator) es una plataforma de emulación y virtualización desarrollada inicialmente por Fabrice Bellard en el año 2003 
\cite{qemu_wikipedia}. Desde sus comienzos, QEMU se diseñó como un emulador rápido, capaz de ejecutar código binario destinado a una arquitectura de hardware
distinta a la del host. A lo largo de los años, ha evolucionado hasta convertirse en una herramienta de referencia para el desarrollo,
prueba y validación de sistemas operativos, firmwares y sistemas embebidos \cite{qemu}.

Una de sus características más destacadas es su capacidad para emular una amplia variedad de arquitecturas, incluyendo x86, 
ARM, RISC-V, PowerPC, SPARC, MIPS, entre otras \cite{qemu_wikipedia}. Esta versatilidad lo convierte en una solución ideal tanto para entornos 
académicos como industriales que requieren validar software sobre arquitecturas heterogéneas. 
QEMU también ofrece integración nativa con herramientas de depuración como GDB, lo que permite analizar en detalle el 
comportamiento del sistema emulado, incluyendo registros, memoria y puntos de interrupción \cite{qemu}.

Adicionalmente, su arquitectura modular ha permitido que sea adoptado como base para otras herramientas y tecnologías de virtualización,
como KVM (Kernel-based Virtual Machine), virt-manager, y plataformas de automatización de pruebas \cite{qemu_wikipedia,qbox2016}. 
Esta extensibilidad ha sido clave para su adopción masiva y su continua evolución dentro del ecosistema del software libre.

\subsection{Casos de uso comunes}

QEMU ha encontrado aplicaciones en una amplia gama de escenarios. En el desarrollo de sistemas operativos y firmwares, 
permite a los ingenieros ejecutar y depurar código sin necesidad de disponer de hardware físico, facilitando la validación 
temprana de componentes críticos \cite{zabolotny2021qemu,zabolotny2022daq}. 
Es especialmente útil en el caso de nuevas arquitecturas como RISC-V, donde el hardware puede no estar aún disponible o puede ser costoso 
\cite{waterman2011riscv,riscv_wikipedia}.

En el contexto de la integración continua (CI/CD), QEMU se emplea para ejecutar automáticamente pruebas de regresión, 
validación funcional y pruebas de integración \cite{cinque2021qemu,githubactions}. Gracias a su capacidad de ser ejecutado en entornos desatendidos 
y su soporte para salida sin interfaz gráfica (\texttt{-nographic}), es una herramienta ideal para pipelines de testing en entornos embebidos.

También es ampliamente utilizado en entornos educativos, donde permite a estudiantes interactuar con sistemas reales emulados, 
experimentar con arquitecturas de bajo nivel, y entender mejor el funcionamiento de sistemas operativos y microprocesadores 
\cite{zabolotny2021qemu}. 
Además, permite simular periféricos específicos, lo cual es de gran utilidad para el estudio de controladores y subsistemas de entrada/salida \cite{qemu}.

En definitiva, QEMU ha trascendido su papel original como emulador para convertirse en una plataforma versátil y esencial en el desarrollo moderno de sistemas informáticos.

\section{Aplicaciones reales de QEMU en investigación e industria}
\label{sec:estado-arte-industria}

La emulación de hardware mediante herramientas como QEMU ha dejado de ser un recurso limitado a laboratorios académicos o pruebas aisladas, 
para convertirse en un componente esencial dentro del ciclo de vida del software embebido. En la actualidad, 
QEMU se emplea activamente tanto en entornos de investigación como en procesos industriales, cumpliendo un rol central en el desarrollo temprano, 
la validación funcional y la automatización de pruebas \cite{zabolotny2021qemu,cinque2021qemu}.

El auge de arquitecturas abiertas como RISC-V, sumado a la creciente complejidad de los SoCs modernos,
ha impulsado la adopción de plataformas virtualizadas como medio para reducir la dependencia del hardware físico y acelerar los ciclos de desarrollo 
\cite{waterman2011riscv,riscv_wikipedia}. La emulación permite validar periféricos, probar sistemas operativos, depurar errores y realizar regresiones en múltiples 
configuraciones de hardware desde entornos reproducibles y automatizables.

A continuación, se presentan ejemplos representativos que ilustran las capacidades actuales de QEMU:\@

\begin{itemize}
    \item \textbf{Sistemas DAQ embebidos (Zabo{\l}otny, 2021–2022):} Se empleó QEMU para validar de forma simultánea el firmware FPGA, 
    el controlador de kernel en Linux y la aplicación de usuario, facilitando el desarrollo iterativo de sistemas de adquisición de 
    datos sin requerir tarjetas físicas PCIe \cite{zabolotny2022daq}.
    
    \item \textbf{Plataformas MIPS64 embebidas (Mehmood et al., 2016):} QEMU fue extendido para emular Octeon, una arquitectura MIPS64 
    utilizada en sistemas embebidos, demostrando que la emulación puede alcanzar desempeños comparables al hardware real durante las 
    etapas iniciales del desarrollo \cite{mehmood2016octeon}.
    
    \item \textbf{Rehosting de firmware embebido (Jiang et al., 2021):} Se desarrolló una técnica para reemplazar periféricos reales por 
    equivalentes virtuales compatibles, permitiendo ejecutar imágenes Linux embebidas originales dentro de QEMU.\@ Esta técnica, 
    conocida como \emph{trasplante de periféricos}, alcanzó una tasa de éxito del 87\% en más de 800 firmwares \cite{jiang2021ecmo}.
    
    \item \textbf{Emulación de SoCs IoT (Osman, 2020):} El SoC nRF51 fue emulado exitosamente en QEMU, ejecutando sistemas operativos como Zephyr. 
    Aunque con ciertas limitaciones temporales, la velocidad y funcionalidad fueron suficientes para validar aplicaciones embebidas IoT \cite{qemu_wikipedia}\cite{osman2020nrf51}. 
    
    \item \textbf{Sistemas críticos y virtualización (Cinque et al., 2021):} En entornos aeroespaciales y automotrices, 
    QEMU se ha empleado como base para pruebas certificables, habilitando aislamiento funcional y validación de componentes críticos 
    sin acceso al hardware final \cite{cinque2021qemu}.
\end{itemize}

\vspace{1em}
Estos casos reflejan una tendencia creciente: el uso de QEMU no se limita a simular CPU, sino que se ha convertido en una herramienta clave
para modelar sistemas embebidos completos, incluyendo buses, periféricos personalizados, controladores de interrupciones y más \cite{qbox2016}. 
Su integración con pipelines CI, su compatibilidad con arquitecturas modernas y su naturaleza extensible lo convierten en un recurso 
estratégico para el diseño confiable de sistemas embebidos contemporáneos.

\section{Emulación con QEMU en RISC-V y entornos de integración continua}
\label{subsec:riscv-ci-industria}

El auge de la arquitectura \texttt{RISC-V}, impulsado por su naturaleza abierta y modular \cite{waterman2011riscv,riscv_wikipedia}, 
ha favorecido el desarrollo de herramientas y flujos de trabajo que dependen fuertemente de la emulación. 
En este contexto, \texttt{QEMU} \cite{qemu} se ha consolidado como una plataforma fundamental para ejecutar, depurar y validar software en arquitecturas 
\texttt{RISC-V} incluso en ausencia de hardware físico. 
Su integración con pipelines de integración continua (CI) permite una validación sistemática y automatizada de firmwares, sistemas operativos 
y componentes críticos, habilitando el desarrollo confiable de productos embebidos \cite{githubactions}.

\subsection*{CI para verificación funcional en RISC-V: Proyecto Caliptra}

Antmicro, en colaboración con Google y otras compañías del consorcio CHIPS Alliance, implementó un pipeline de CI para validar de 
forma continua el núcleo VeeR de \texttt{RISC-V} dentro del proyecto Caliptra, utilizado en soluciones de raíz de confianza por empresas como AMD,
Microsoft y NVIDIA. Esta infraestructura ejecuta pruebas funcionales y de cobertura RTL en cada commit sobre múltiples configuraciones del core 
(EH1, EH2, EL2), garantizando estabilidad, seguridad y mantenibilidad del hardware \cite{chipsalliance_caliptra_ci,riscv_summit_veer_ci}.

\subsection*{Testing de Linux RISC-V en CI con hardware real y virtual}

En Codethink, se desarrolló un pipeline de CI sobre GitLab que combina la emulación en \texttt{QEMU} con despliegue automático sobre 
hardware real (placas SiFive Unmatched). Se utilizan herramientas como LAVA y OpenQA para validar el arranque, login y funcionamiento 
básico de una imagen Linux construida para \texttt{RISC-V}, asegurando que las modificaciones en el kernel o el entorno de usuario 
no introduzcan regresiones \cite{codethink_riscv_kernel_ci,codethink_testing_in_box}.

\subsection*{Pruebas automatizadas de RTOS y firmware}

Proyectos como Apache NuttX emplean \texttt{QEMU} dentro de pipelines CI para validar binarios de firmware embebido. 
En cada ejecución, el sistema arranca una imagen y analiza su salida para detectar errores de acceso a memoria, 
fallos de segmentación o comportamiento incorrecto, todo ello sin necesidad de hardware físico \cite{rise_riscv_ci}.

\subsection*{Adopción comunitaria en entornos profesionales}

Foros y espacios técnicos de desarrollo embebido (como Reddit r/embedded) reflejan una adopción generalizada de \texttt{QEMU} como 
entorno de pruebas unitarias y de integración. Muchas compañías y desarrolladores independientes emplean \texttt{GitHub Actions} o 
\texttt{Jenkins} junto con \texttt{QEMU} para ejecutar baterías de tests en CI, simulando arquitecturas \texttt{RISC-V}, \texttt{ARM} o \texttt{MIPS}. 
En ocasiones, estos entornos se complementan con hardware real conectado mediante runners personalizados, permitiendo una validación híbrida \cite{githubactions}.

\vspace{1em}
En conjunto, estos casos confirman que el uso de \texttt{QEMU} en CI ha trascendido el ámbito experimental. 
Hoy es una herramienta central en procesos DevOps aplicados a sistemas embebidos, ofreciendo una base sólida para la 
validación funcional de arquitecturas abiertas como \texttt{RISC-V}, con beneficios concretos en tiempo de desarrollo, 
reproducibilidad y robustez del software.

\section{Procesadores Gaisler y la arquitectura NOEL-V}
\label{subsec:gaisler-noelv}

Gaisler, una división de CAES, es reconocida por sus procesadores orientados a sistemas espaciales y críticos. 
Sus productos incluyen \cite{gaisler-noelv,grlib}:

\begin{itemize}
    \item \textbf{LEON:} Familia de procesadores basados en SPARC V8, ampliamente utilizados en aplicaciones espaciales y sistemas críticos.
    \item \textbf{NOEL-V:} Primer procesador \texttt{RISC-V} desarrollado por Gaisler \cite{gaisler-noelv,waterman2011riscv}.
    \item \textbf{GRLIB:} Biblioteca IP en VHDL que incluye UARTs, timers, GPIOs y otros periféricos \cite{grlib}.
    \item \textbf{NCC Toolchain:} Toolchain GCC/GDB adaptada para sistemas Gaisler.
\end{itemize}

Este trabajo replica el entorno de una plataforma \texttt{NOEL-V} compatible con \texttt{GRLIB}, utilizando \texttt{QEMU} como emulador de sistema completo. 
Dada la dificultad de acceso al hardware real en contextos críticos, como el aeroespacial, 
el uso de entornos virtuales como \texttt{QEMU} resulta clave para validar el software en condiciones reproducibles \cite{cinque2021qemu,zabolotny2021qemu}.

\section{Conclusión del capítulo}

La emulación mediante \texttt{QEMU} representa hoy una herramienta consolidada tanto en la investigación como en la industria. 
En el contexto de este TFG, su uso permite abordar el diseño y prueba de un sistema embebido complejo basado en \texttt{RISC-V} y 
periféricos \texttt{GRLIB}, replicando entornos industriales como los de Gaisler sin requerir hardware físico. 
El marco teórico y estado del arte presentado sienta así las bases para el desarrollo práctico abordado en los capítulos siguientes.

